var assetsPath = 'assets/images/';
var three = require('three');

var texturesData = [
	'target.png',
	'icon_boy2.png',
	'icon_cat.png',
	'icon_dog.png',
	'icon_girl.png',
	'icon_wife.png',
	'icon_goat.png'
];

var textures = {};
var materials = {};

var ready;


var texturesToLoad = texturesData.length;
function onSuccess(fileName, texture) {
	texture.minFilter = THREE.NearestFilter;
	texture.magFilter = THREE.NearestFilter;
	if(materials[fileName]) {
		materials[fileName].map = texture;
	}
	textures[fileName] = texture;
	texturesToLoad--;
	if(texturesToLoad === 0) {
		ready();
	}
}

function onError() {
	throw new Error('Nope!');
}

var geometry;
function getGeometry(){
	if(!geometry) {
		geometry = new three.PlaneGeometry(1, 1);
	}
	return geometry;
}

function getMaterial(fileName) {
	if(!materials[fileName]) {
		var texture = textures[fileName];
		materials[fileName] = new three.MeshBasicMaterial({
			map: texture,
			// transparent: true,
			// depthTest: false
			alphaTest: 0.5
		});
	}
	return materials[fileName];
}

function getSprite(fileName) {
	if(texturesData.indexOf(fileName) === -1) {
		throw new Error(fileName, 'does not exist.');
	}
	var geometry = getGeometry();
	var material = getMaterial(fileName);
	var mesh = new three.Mesh(geometry, material);
	mesh.scale.set(material.map.image.width, material.map.image.height, 1);
	return mesh;
}

function init(callback) {
	ready = callback;
	texturesData.forEach(function(fileName) {
		var texture = three.ImageUtils.loadTexture(
			assetsPath + fileName,
			undefined,
			onSuccess.bind(null, fileName),
			onError
		);
		textures[fileName] = texture;
	});
}

module.exports = {
	getSprite:getSprite,
	init: init
};
