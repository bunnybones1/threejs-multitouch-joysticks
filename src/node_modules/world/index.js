var three = require('three');
var textures = require('textures');
var tweener = require('tweener');
var physics = require('physics');

var initd = false;

var scene;

function init() {
	if(initd) return;
	initd = true;

	scene = new three.Scene();
	module.exports.scene = scene;

	delete module.exports.init;
}

function spawnDeathToll(person) {
	var family ={};
	family.children = [];
	family.pets = [];

	family.wife = Math.random() > 0.5 ? true : false;
	var children  = Math.random ()> 0.5  ? true : false;
	var pets  = Math.random ()> 0.5  ? true : false;

	if (family.wife && children) {
		numChild = ~~(Math.random() * 3);
		for (i = 0; i < numChild; i++) { 
			if (Math.random() > 0.5) { 
				family.children.push('icon_boy2.png');
			}
			else {
				family.children.push('icon_girl.png');	
			}
		}
	}
	if (pets) {
		numPets = ~~(Math.random() * 3);
		for (i = 0; i < numPets; i++) { 
			if (Math.random() > 0.5) { 
				family.pets.push('icon_dog.png');
			}
			else {
				family.pets.push('icon_cat.png');	
			}
		}
	}
	
	var cursor = 0;
	if (family.wife) {
		cursor+=getMesh('icon_wife.png', person, cursor);
	}
	if (family.children.length > 0){
		family.children.forEach(function(child) {
			cursor+=getMesh(child, person, cursor);
		});
	}
	if (family.pets.length > 0){
		family.pets.forEach(function(pet) {
			cursor+=getMesh(pet, person, cursor);
		});
	}
}

function getMesh(filename, person, offsetX) { 
	var mesh = textures.getSprite(filename);
	//debugger;
	mesh.position.copy(person.mesh.position);
	mesh.position.x += offsetX;
	mesh.position.z = person.height;
	mesh.rotation.x = Math.PI * 0.5;
	scene.add(mesh);
	tweener.to(mesh.position, 2, {
		z: mesh.position.z + 200,
		onComplete: function() {
			mesh.parent.remove(mesh);
		}
	});
	return mesh.scale.x;
}

function targetSpriteAt(position) {
	var mesh = textures.getSprite('target.png');
	mesh.position.x = position.x * physics.SCALE_INV;
	mesh.position.y = position.y * physics.SCALE_INV;
	mesh.scale.multiplyScalar(0.3);
	scene.add(mesh);
	tweener.to(mesh.scale, 0.5, {
		x: mesh.scale.x + 50,
		y: mesh.scale.y + 50,
		onComplete: function() {
			mesh.parent.remove(mesh);
		}
	});
}

module.exports = {
	init: init,
	death:spawnDeathToll,
	targetSpriteAt: targetSpriteAt
};