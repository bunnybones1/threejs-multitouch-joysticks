var defaults = require('lodash.defaults');
var physics = require('physics');
var world = require('world');
var three = require('three');

var defaultActorParams = {
	name: 'hero',
	shape: 'circle',
	radius: 25,
	mass: 1,
	friction: 0,
	x: 300,
	y: 200,
	categoryBits: 2,
	maskBits: 1 | 4,
	fixedRotation: true,
	linearDamping: 1
};


function Hero(params) {
	params = params || {};
	this.walkForce = new physics.Box2D.b2Vec2(0.075, 0);
	defaults(params, defaultActorParams);
	var mesh = new THREE.Mesh(new THREE.SphereGeometry(params.radius, 16, 8));
	this.mesh = mesh;
	params.mesh = mesh;
	this.body = physics.addActor(params);
	this.fixture = this.body.GetFixtureList();
	var min = new THREE.Vector3(-150, -150, -150);
	this.minOffset = min.clone();
	var max = new THREE.Vector3(150, 150, 150);
	this.maxOffset = max.clone();
	this.sightBounds = new THREE.Box3(min, max);
}

var geometry;
function getGeometry() {
	if(!geometry) {
		geometry = new three.PlaneGeometry(20, 20, 1, 1);
	}
	return geometry;
}
var material;
function getMaterial() {
	if(!material) {
		material = new three.MeshBasicMaterial({
			wireframe: true,
			color: 0xffffff
		});
	}
	return material;
}

Hero.prototype.updateWalk = function() {
	
	this.walkForce.x = (-this.body.GetLinearVelocity().x * 0.5);
	this.body.ApplyForce(this.walkForce, this.body.GetPosition());
}

Hero.prototype.getSightBounds = function() {
	this.sightBounds.min.copy(this.mesh.position).add(this.minOffset);
	this.sightBounds.max.copy(this.mesh.position).add(this.maxOffset);
	this.sightBounds.min.y = Math.max(this.sightBounds.min.y, physics.floorBody.bodyMesh.position.y);
	this.sightBounds.max.y = Math.min(this.sightBounds.max.y, physics.ceilingBody.bodyMesh.position.y);
	return this.sightBounds;
}

Hero.prototype.walk = function(value) {
	this.walkForce.x = (value * physics.SCALE);
};

module.exports = Hero;